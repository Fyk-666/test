<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的文章管理</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- 基础 UI 样式 --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container { width: 95%; max-width: 1200px; margin-top: 100px; padding-bottom: 50px; }

        .header-title {
            text-align: center; font-size: 3rem; font-weight: bold;
            letter-spacing: 5px; margin-bottom: 15px;
            text-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* --- 筛选工具栏 --- */
        .filter-bar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex; flex-wrap: wrap; gap: 15px; align-items: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .filter-group { display: flex; align-items: center; gap: 10px; }
        .filter-group label { font-size: 0.9rem; opacity: 0.9; white-space: nowrap; }

        .filter-input, .filter-select {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px; padding: 8px 15px; color: white; outline: none; transition: all 0.3s;
        }
        .filter-select option { background: #764ba2; color: white; }

        .search-box { flex-grow: 1; min-width: 250px; position: relative; }
        .search-box i { position: absolute; right: 15px; top: 12px; opacity: 0.6; }
        .search-box input { width: 100%; padding-right: 40px; }

        /* --- 按钮样式 --- */
        .btn {
            padding: 10px 25px; font-size: 1rem; font-weight: bold;
            border-radius: 12px; cursor: pointer; transition: all 0.3s;
            text-decoration: none; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary { background: white; color: #764ba2; border: none; }
        .btn-glass { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4); backdrop-filter: blur(10px); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        /* --- 文章网格 --- */
        .article-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px; padding-bottom: 50px;
        }

        /* --- 修改：卡片改为 div 布局以支持内部按钮 --- */
        .article-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 25px;
            height: 200px;
            display: flex; flex-direction: column; justify-content: space-between;
            transition: all 0.3s;
            position: relative;
            cursor: pointer; /* 让整个卡片看起来可点击 */
        }

        .article-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .status-badge {
            position: absolute; top: 15px; right: 15px;
            padding: 3px 10px; border-radius: 8px; font-size: 0.75rem;
        }
        .status-published { background: rgba(46, 204, 113, 0.3); border: 1px solid #2ecc71; }
        .status-draft { background: rgba(241, 196, 15, 0.3); border: 1px solid #f1c40f; }

        .card-title { font-size: 1.3rem; font-weight: bold; line-height: 1.4; margin-top: 20px; color: white; }
        .card-meta { display: flex; justify-content: space-between; font-size: 0.85rem; opacity: 0.7; color: white; padding-right: 50px; }

        /* --- 新增：删除按钮样式 --- */
        .delete-btn {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.5);
            color: #ffcccc;
            width: 32px; height: 32px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s;
            z-index: 10; /* 确保在最上层 */
        }
        .delete-btn:hover {
            background: rgba(231, 76, 60, 0.8);
            color: white;
            transform: scale(1.1);
        }
        /* 禁用的删除按钮 (过期) */
        .delete-btn.disabled {
            background: rgba(128, 128, 128, 0.1);
            border-color: rgba(128, 128, 128, 0.3);
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
        }
        .delete-btn.disabled:hover { transform: none; background: rgba(128, 128, 128, 0.1); }

        #loading { text-align: center; padding: 50px; font-size: 1.2rem; }

        /* --- 统一导航栏样式 --- */
        .unified-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
        }
        .nav-container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: #764ba2;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .nav-logo i { font-size: 1.5rem; }
        .nav-menu {
            display: flex;
            list-style: none;
            gap: 25px;
        }
        .nav-menu a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s;
            padding: 8px 12px;
            border-radius: 8px;
        }
        .nav-menu a:hover {
            color: #764ba2;
            background: rgba(102, 126, 234, 0.1);
        }
    </style>
</head>
<body>
    <!-- 统一导航栏 -->
    <nav class="unified-nav">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">
                <i class="fas fa-graduation-cap"></i>
                <span>班级网站</span>
            </a>
            <ul class="nav-menu">
                <li><a href="index.html">首页</a></li>
                <li><a href="article_list.html">班级公告</a></li>
                <li><a href="toolbox.html">工具箱</a></li>
                <li><a href="article.html">发文章</a></li>
                <li><a href="#">班级相册</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <h1 class="header-title">我的内容</h1>
        
        <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 30px;">
            <a href="#" id="publishBtn" class="btn btn-primary"><i class="fas fa-plus"></i> 写文章</a>
            <a href="#" id="backBtn" class="btn btn-glass"><i class="fas fa-home"></i> 首页</a>
        </div>

        <div class="filter-bar">
            <div class="filter-group search-box">
                <input type="text" id="searchInp" class="filter-input" placeholder="搜索文章标题...">
                <i class="fas fa-search"></i>
            </div>
            <div class="filter-group">
                <label>状态:</label>
                <select id="statusSel" class="filter-select">
                    <option value="all">全部</option>
                    <option value="published">已发布</option>
                    <option value="draft">草稿箱</option>
                </select>
            </div>
            <div class="filter-group">
                <label>时间:</label>
                <select id="timeSel" class="filter-select">
                    <option value="all">不限时间</option>
                    <option value="today">今日</option>
                    <option value="week">本周</option>
                    <option value="month">本月</option>
                    <option value="year">今年</option>
                </select>
            </div>
            <div class="filter-group">
                <label>排序:</label>
                <select id="sortSel" class="filter-select">
                    <option value="desc">最新发布</option>
                    <option value="asc">最早发布</option>
                </select>
            </div>
        </div>

        <div id="loading">正在加载数据...</div>
        <div id="article-grid" class="article-grid"></div>
    </div>

    <script>
        const isTestEnv = window.location.pathname.includes('/test/');
        const prefix = isTestEnv ? '/test' : '';
        const GITHUB_PAGE_BASE = `https://fyk-666.github.io/test/static/articles/html/`;
        // 注意：这里请改成你实际的后端地址
        const API_URL = "https://kczx.pythonanywhere.com/api/articles?page_size=100&status=all";
        
        let allMyArticles = []; 

        function parseJwt(token) {
            try {
                return JSON.parse(atob(token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
            } catch (e) { return null; }
        }

        async function init() {
            const loading = document.getElementById('loading');
            const token = localStorage.getItem('token');

            if (!token) {
                loading.innerHTML = `<div style="text-align:center"><p>请先登录以查看个人内容</p><br><a href="${prefix}/login" class="btn btn-primary">去登录</a></div>`;
                return;
            }

            const user = parseJwt(token);
            if (!user) {
                loading.innerText = '身份验证过期';
                return;
            }
            const currentUsername = user.username;

            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                
                allMyArticles = data.articles.filter(a => a.author === currentUsername);
                
                loading.style.display = 'none';
                renderArticles(allMyArticles);

                [document.getElementById('searchInp'), document.getElementById('statusSel'),
                 document.getElementById('timeSel'), document.getElementById('sortSel')]
                .forEach(el => el.addEventListener('input', applyFilters));

            } catch (e) {
                loading.innerText = '加载失败，请检查网络';
            }
        }

        function applyFilters() {
            const searchText = document.getElementById('searchInp').value.toLowerCase();
            const statusFilter = document.getElementById('statusSel').value;
            const timeFilter = document.getElementById('timeSel').value;
            const sortOrder = document.getElementById('sortSel').value;

            let filtered = allMyArticles.filter(article => {
                const matchSearch = article.title.toLowerCase().includes(searchText);
                const matchStatus = statusFilter === 'all' || article.status === statusFilter;
                const matchTime = checkTimeMatch(article.created_at, timeFilter);
                return matchSearch && matchStatus && matchTime;
            });

            filtered.sort((a, b) => {
                const timeA = new Date(a.created_at).getTime();
                const timeB = new Date(b.created_at).getTime();
                return sortOrder === 'desc' ? timeB - timeA : timeA - timeB;
            });

            renderArticles(filtered);
        }

        function checkTimeMatch(dateStr, filter) {
            if (filter === 'all') return true;
            const articleDate = new Date(dateStr);
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            switch(filter) {
                case 'today': return articleDate.getTime() >= todayStart;
                case 'week': return (now - articleDate) <= 7 * 24 * 3600 * 1000;
                case 'month': return articleDate.getMonth() === now.getMonth() && articleDate.getFullYear() === now.getFullYear();
                case 'year': return articleDate.getFullYear() === now.getFullYear();
                default: return true;
            }
        }

        // --- 核心修改：渲染函数 + 删除逻辑 ---
        function renderArticles(list) {
            const grid = document.getElementById('article-grid');
            grid.innerHTML = '';

            if (list.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:50px;opacity:0.6;">没有找到匹配的文章</div>';
                return;
            }

            // 计算3个月前的时间戳
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
            const limitTime = threeMonthsAgo.getTime();

            list.forEach(article => {
                // 卡片改成 div，通过 JS 跳转
                const card = document.createElement('div');
                card.className = 'article-card';
                
                // 点击卡片跳转到 GitHub Pages (除去删除按钮的点击)
                card.onclick = (e) => {
                    window.open(`${GITHUB_PAGE_BASE}${article.id}.html`, '_blank');
                };

                const statusLabel = article.status === 'published' ? '已发布' : '草稿';
                const statusClass = article.status === 'published' ? 'status-published' : 'status-draft';
                const createdDate = new Date(article.created_at);
                
                // 判断是否超过3个月
                const isTooOld = createdDate.getTime() < limitTime;
                
                // 生成删除按钮 HTML
                // 如果太久远，添加 disabled 类和提示；否则绑定删除事件
                let deleteBtnHtml = '';
                if (isTooOld) {
                    deleteBtnHtml = `
                        <button class="delete-btn disabled" title="超过3个月的文章无法删除" onclick="event.stopPropagation(); alert('为了数据安全，超过3个月的文章已被锁定，无法删除。');">
                            <i class="fas fa-lock"></i>
                        </button>
                    `;
                } else {
                    // 注意：这里 onclick 调用 deleteArticle，并传入 ID
                    deleteBtnHtml = `
                        <button class="delete-btn" title="删除文章" onclick="deleteArticle(event, '${article.id}', '${article.title}')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                }

                card.innerHTML = `
                    <div class="status-badge ${statusClass}">${statusLabel}</div>
                    <div class="card-title">${article.title}</div>
                    <div class="card-meta">
                        <span><i class="far fa-calendar-alt"></i> ${createdDate.toLocaleDateString()}</span>
                        <span><i class="far fa-clock"></i> ${createdDate.getHours()}:00</span>
                    </div>
                    ${deleteBtnHtml}
                `;
                grid.appendChild(card);
            });
        }

        // --- 新增：删除功能实现 ---
        async function deleteArticle(event, articleId, articleTitle) {
            // 阻止事件冒泡（防止触发卡片的跳转）
            event.stopPropagation();

            const token = localStorage.getItem('token');
            if (!token) {
                alert("登录状态已失效，请重新登录");
                window.location.href = prefix + '/login';
                return;
            }

            // 1. 弹窗确认
            const confirmMsg = `⚠️ 警告操作 ⚠️\n\n您确定要删除文章《${articleTitle}》吗？\n\n此操作将：\n1. 从数据库中移除\n2. 删除 GitHub 仓库中的文件\n3. 不可恢复！`;
            if (!confirm(confirmMsg)) return;

            try {
                // 显示删除中状态（可选，改变按钮样式）
                const btn = event.currentTarget;
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.style.pointerEvents = 'none';

                // 2. 发送请求
                // 注意：这里使用的是后端 article.py 中定义的删除接口
                // 后端逻辑中已经包含了 token 验证和权限检查
                const response = await fetch(`https://kczx.pythonanywhere.com/api/articles/${articleId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    alert("删除成功！");
                    // 3. 成功后从本地数据移除并重新渲染，无需刷新页面
                    allMyArticles = allMyArticles.filter(a => String(a.id) !== String(articleId));
                    applyFilters(); // 重新应用当前的筛选状态
                } else {
                    alert("删除失败: " + (data.error || "未知错误"));
                    btn.innerHTML = originalContent;
                    btn.style.pointerEvents = 'auto';
                }

            } catch (err) {
                console.error(err);
                alert("网络请求出错，请检查连接");
                const btn = event.currentTarget;
                if(btn) {
                    btn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    btn.style.pointerEvents = 'auto';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const publishBtn = document.getElementById('publishBtn');
            const backBtn = document.getElementById('backBtn');
            if (publishBtn) publishBtn.href = prefix + '/article';
            if (backBtn) backBtn.href = prefix + '/article_list';
            init();
        });
    </script>
</body>
</html>
