<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ–‡ç« </title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- å¤ç”¨ä¹‹å‰çš„æ¯›ç»ç’ƒ UI æ ·å¼ --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin-top: 60px;
        }

        .header-title {
            text-align: center;
            font-size: 3.5rem;
            font-weight: bold;
            letter-spacing: 5px;
            margin-bottom: 20px;
            text-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .sub-header {
            text-align: center;
            margin-bottom: 40px;
            opacity: 0.8;
            font-size: 1.1rem;
        }

        .action-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 60px;
        }

        .btn {
            padding: 12px 30px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: white;
            color: #764ba2;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-primary:hover { transform: translateY(-3px); }

        /* è¿”å›é¦–é¡µæŒ‰é’® */
        .btn-glass {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
        }
        .btn-glass:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-3px); }

        .article-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 30px;
            padding-bottom: 50px;
        }

        .article-card {
            display: block;
            text-decoration: none;
            color: white;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            padding: 30px;
            height: 220px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.3s, background 0.3s;
            position: relative;
        }

        .article-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* çŠ¶æ€æ ‡ç­¾ */
        .status-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .status-published { background: rgba(46, 204, 113, 0.4); color: #eaffea; border: 1px solid rgba(46, 204, 113, 0.6); }
        .status-draft { background: rgba(241, 196, 15, 0.4); color: #fffbea; border: 1px solid rgba(241, 196, 15, 0.6); }

        .card-title {
            font-size: 1.4rem;
            text-align: center;
            font-weight: bold;
            margin-top: 15px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .card-divider {
            height: 1px;
            border: none;
            border-top: 1px dashed rgba(255,255,255,0.5);
            margin: 10px 20px;
        }

        .card-info {
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        #loading { text-align: center; font-size: 1.2rem; color: rgba(255,255,255,0.8); margin-top: 50px;}
    </style>
</head>
<body>

    <div class="container">
        <h1 class="header-title">æˆ‘çš„æ–‡ç« </h1>
        <div class="sub-header" id="welcome-msg">ç®¡ç†æ‚¨å‘å¸ƒçš„ä¸ªäººå†…å®¹</div>

        <div class="action-bar">
            <!-- æ™ºèƒ½è·³è½¬åˆ°å‘å¸ƒé¡µ -->
            <a href="#" id="publishBtn" class="btn btn-primary">
                <i class="fas fa-pen-nib"></i> å†™æ–°æ–‡ç« 
            </a>
            <!-- è¿”å›å…¬å…±åˆ—è¡¨ -->
            <a href="#" id="backBtn" class="btn btn-glass">
                <i class="fas fa-arrow-left"></i> æµè§ˆå…¨éƒ¨æ–‡ç« 
            </a>
        </div>

        <div id="loading">æ­£åœ¨éªŒè¯èº«ä»½å¹¶è·å–æ•°æ®...</div>
        <div id="article-grid" class="article-grid"></div>
    </div>

    <script>
        // --- 1. JWT è§£æå‡½æ•° (ç”¨äºè·å–å½“å‰ç”¨æˆ·å) ---
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        // --- 2. é…ç½® ---
        // æ™ºèƒ½è¯†åˆ«å½“å‰æ˜¯å¦åœ¨ test ç›®å½•ä¸‹ (GitHub Pages ç¯å¢ƒ)
        const isTestEnv = window.location.pathname.includes('/test/');
        const prefix = isTestEnv ? '/test' : '';
        const GITHUB_PAGE_BASE = `https://fyk-666.github.io/test/static/articles/html/`;
        
        // è·å–æ‰€æœ‰çŠ¶æ€çš„æ–‡ç« ï¼ŒåŒ…æ‹¬è‰ç¨¿
        const API_URL = "https://kczx.pythonanywhere.com/api/articles?page_size=100&status=all";

        // --- 3. æ ¸å¿ƒé€»è¾‘ ---
        async function loadMyArticles() {
            const grid = document.getElementById('article-grid');
            const loading = document.getElementById('loading');
            const welcomeMsg = document.getElementById('welcome-msg');

            // 1. è·å– Token
            const token = localStorage.getItem('token');
            if (!token) {
                loading.innerHTML = 'æ‚¨å°šæœªç™»å½•ï¼Œæ— æ³•æŸ¥çœ‹ä¸ªäººæ–‡ç« ã€‚<br><a href="/login" style="color:white;text-decoration:underline;">å»ç™»å½•</a>';
                return;
            }

            // 2. è§£æç”¨æˆ·ä¿¡æ¯
            const user = parseJwt(token);
            if (!user) {
                loading.innerText = 'èº«ä»½éªŒè¯å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•ã€‚';
                return;
            }
            const currentUsername = user.username;
            welcomeMsg.innerText = `å½“å‰ç”¨æˆ·ï¼š${currentUsername} | ç®¡ç†æ‚¨çš„åˆ›ä½œ`;

            try {
                // 3. è¯·æ±‚æ•°æ®
                const response = await fetch(API_URL);
                const data = await response.json();
                loading.style.display = 'none';

                if (!data.articles) {
                    loading.style.display = 'block';
                    loading.innerText = 'æ•°æ®è·å–å¼‚å¸¸';
                    return;
                }

                // 4. å‰ç«¯è¿‡æ»¤ï¼šåªä¿ç•™ä½œè€…æ˜¯å½“å‰ç”¨æˆ·çš„æ–‡ç« 
                // æ³¨æ„ï¼šè¿™é‡Œæ¯”è¾ƒçš„æ˜¯ usernameï¼Œå¦‚æœä½ çš„åç«¯è¿”å›çš„æ˜¯ author_name å­—æ®µ
                const myArticles = data.articles.filter(article => article.author === currentUsername);

                if (myArticles.length === 0) {
                    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;font-size:1.2rem;opacity:0.8;">æ‚¨è¿˜æ²¡æœ‰å‘å¸ƒè¿‡ä»»ä½•æ–‡ç« </div>';
                    return;
                }

                // 5. æ¸²æŸ“å¡ç‰‡
                myArticles.forEach(article => {
                    // æ„å»ºè·³è½¬é“¾æ¥ (GitHub Pages)
                    const targetUrl = `${GITHUB_PAGE_BASE}${article.id}.html`;
                    
                    // æ„å»ºç¼–è¾‘é“¾æ¥ (æ™ºèƒ½å‰ç¼€ + ä¼ å‚)
                    // æ¯”å¦‚: /test/article?id=12345
                    const editUrl = `${prefix}/article?id=${article.id}`;

                    const card = document.createElement('div'); // å¤–å±‚å®¹å™¨
                    card.style.position = 'relative'; // ä¸ºäº†å®šä½å¡ç‰‡
                    
                    // å¡ç‰‡ä¸»ä½“ (ç‚¹å‡»è·³è½¬åˆ°æ–‡ç« è¯¦æƒ…)
                    // å¦‚æœæ˜¯è‰ç¨¿ï¼Œå¯èƒ½ GitHub ä¸Šè¿˜æ²¡ç”Ÿæˆï¼Œä½ å¯ä»¥é€‰æ‹©è·³åˆ°ç¼–è¾‘é¡µï¼Œè¿™é‡Œé»˜è®¤éƒ½è·³ HTML
                    const cardLink = document.createElement('a');
                    cardLink.className = 'article-card';
                    cardLink.href = targetUrl;
                    cardLink.target = '_blank';

                    // çŠ¶æ€æ ‡ç­¾æ–‡æœ¬
                    const statusText = article.status === 'published' ? 'å·²å‘å¸ƒ' : 'è‰ç¨¿';
                    const statusClass = article.status === 'published' ? 'status-published' : 'status-draft';

                    cardLink.innerHTML = `
                        <div class="status-badge ${statusClass}">${statusText}</div>
                        <div class="card-title">${article.title}</div>
                        <div class="card-divider"></div>
                        <div class="card-info">
                            <span>ğŸ“… ${new Date(article.created_at).toLocaleDateString()}</span>
                        </div>
                        <!-- è¿™é‡ŒåŠ ä¸€ä¸ªæç¤ºï¼Œå®é™…ä¸Šè¿™ä¸ªå¡ç‰‡æœ¬èº«å°±æ˜¯é“¾æ¥ -->
                        <div class="card-info" style="margin-top:auto; font-size:0.8rem; color: #a8dadc;">
                            <i class="fas fa-external-link-alt"></i> ç‚¹å‡»æŸ¥çœ‹
                        </div>
                    `;

                    // å°†å¡ç‰‡åŠ å…¥ç½‘æ ¼
                    grid.appendChild(cardLink);

                    // --- 6. (å¯é€‰) å¦‚æœä½ æƒ³åœ¨å¡ç‰‡ä¸Šç›´æ¥åŠ ä¸ªâ€œç¼–è¾‘â€æŒ‰é’® ---
                    // è¿™é‡Œä¸ºäº†ä¿æŒå’Œä½ ä¹‹å‰çš„ UI ä¸€è‡´ï¼Œæˆ‘æ²¡åŠ æ‚¬æµ®æŒ‰é’®ï¼Œ
                    // ä½†ä½ å¯ä»¥ç‚¹å‡»è¿›å»æŸ¥çœ‹ï¼Œæˆ–è€…åœ¨å‘å¸ƒé¡µé€šè¿‡ ID åŠ è½½å›æ¥ç¼–è¾‘ã€‚
                    // å¦‚æœéœ€è¦ç¼–è¾‘æŒ‰é’®ï¼Œå¯ä»¥åœ¨è¿™é‡ŒåŠ¨æ€æ’å…¥ä¸€ä¸ªç»å¯¹å®šä½çš„æŒ‰é’®ã€‚
                });

            } catch (error) {
                console.error('Error:', error);
                loading.style.display = 'block';
                loading.innerText = 'åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åç«¯æœåŠ¡';
            }
        }

        // --- é¡µé¢åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            // è®¾ç½®æŒ‰é’®é“¾æ¥
            const publishBtn = document.getElementById('publishBtn');
            const backBtn = document.getElementById('backBtn');
            
            if (publishBtn) publishBtn.href = prefix + '/article';
            if (backBtn) backBtn.href = prefix + '/article_list';

            // åŠ è½½æ•°æ®
            loadMyArticles();
        });
    </script>
</body>
</html>